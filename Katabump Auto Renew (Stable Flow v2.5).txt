// ==UserScript==
// @name         Katabump Auto Renew (Stable Flow v2.5)
// @namespace    http://tampermonkey.net/
// @version      2.5
// @description  è‡ªåŠ¨ç»­æœŸ v2.5ï¼šå»¶è¿Ÿé”å®šé˜²æ­¢è¯¯æŠ¥å¼‚å¸¸ + ç»“æœä¼˜å…ˆåˆ¤å®š + æ‹ŸäººåŒ–æ“ä½œ
// @author       YourName
// @match        https://dashboard.katabump.com/servers/edit?id=*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // --- 1. é…ç½®å‚æ•° ---
    const CONFIG = {
        targetId: '164794',
        cleanUrl: 'https://dashboard.katabump.com/servers/edit?id=164794',
        refreshInterval: 60 * 60 * 1000,
        storageKey: 'katabump_v2_5',

        // é€‰æ‹©å™¨
        btnRenew: 'button[data-bs-target="#renew-modal"]',
        textCheckSelector: '#renew-modal p',
        textCheckContent: 'extend the life of your server',
        btnConfirm: '#renew-modal button[type="submit"].btn-primary',
        alertSelector: 'div.alert.alert-danger'
    };

    // --- 2. åˆå§‹åŒ–æ•°æ® ---
    let data = JSON.parse(localStorage.getItem(CONFIG.storageKey)) || {
        nextRunTime: 0,
        logs: [],
        isPaused: false,
        status: 'idle', // idle, renewing
        retryCount: 0
    };

    let isBusy = false; // å†…å­˜é”ï¼Œé˜²æ­¢å•æ¬¡è¿è¡Œä¸­é‡å¤è§¦å‘
    let refreshTimer = null;

    // --- 3. UI æ„å»º ---
    const style = document.createElement('style');
    style.innerHTML = `
        #kb-panel {
            position: fixed; bottom: 10px; right: 10px; width: 380px;
            background: #080808; color: #ccc; z-index: 999999;
            border: 1px solid #333; border-radius: 6px; padding: 10px;
            font-family: monospace; font-size: 12px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.9);
        }
        #kb-header { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .kb-btn { cursor: pointer; border: none; padding: 5px 10px; border-radius: 3px; font-weight: bold; margin-right: 5px; }
        .kb-btn-run { background: #198754; color: white; }
        .kb-btn-pause { background: #ffc107; color: black; }
        #kb-logs { height: 160px; overflow-y: auto; background: #000; border: 1px solid #333; margin-top: 8px; padding: 5px; }
        .log-time { color: #555; margin-right: 5px; }
        .log-step { color: #6f42c1; font-weight: bold; border-left: 3px solid #6f42c1; padding-left: 5px; display: block; margin-top: 2px;}
        .log-warn { color: #ffc107; }
        .log-success { color: #198754; }
        .log-error { color: #dc3545; background: rgba(220, 53, 69, 0.1); }
    `;
    document.head.appendChild(style);

    const panel = document.createElement('div');
    panel.id = 'kb-panel';
    panel.innerHTML = `
        <div id="kb-header">
            <span style="color:#6f42c1;">âš“ Katabump V2.5 (Stable)</span>
            <button id="kb-hide" style="background:none;border:none;color:#666;cursor:pointer;">[-]</button>
        </div>
        <div id="kb-content">
            <div id="kb-status" style="margin-bottom:8px; padding:5px; background:#222;">åˆå§‹åŒ–...</div>
            <div>
                <button id="kb-manual" class="kb-btn kb-btn-run">é‡ç½®å¹¶è¿è¡Œ</button>
                <button id="kb-pause" class="kb-btn kb-btn-pause">æš‚åœ</button>
            </div>
            <div id="kb-logs"></div>
        </div>
    `;
    document.body.appendChild(panel);

    const ui = {
        status: document.getElementById('kb-status'),
        logs: document.getElementById('kb-logs'),
        btnManual: document.getElementById('kb-manual'),
        btnPause: document.getElementById('kb-pause'),
        btnHide: document.getElementById('kb-hide'),
        content: document.getElementById('kb-content')
    };

    // --- 4. å·¥å…·å‡½æ•° ---
    function saveData() {
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
    }

    function log(msg, type = 'info') {
        const time = new Date().toLocaleTimeString('en-GB');
        data.logs.unshift({ time, msg, type });
        if (data.logs.length > 50) data.logs.pop();
        saveData();
        renderLogs();
    }

    function renderLogs() {
        ui.logs.innerHTML = data.logs.map(l =>
            `<div><span class="log-time">[${l.time}]</span><span class="log-${l.type}">${l.msg}</span></div>`
        ).join('');
    }

    function updateStatus(text, color = '#fff') {
        ui.status.innerHTML = text;
        ui.status.style.color = color;
    }

    function formatTime(ms) {
        if (ms <= 0) return "00:00:00";
        const d = Math.floor(ms / 86400000);
        const h = Math.floor((ms % 86400000) / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        return `${d}d ${h}h ${m}m ${s}s`;
    }

    function isVisible(elem) {
        return !!(elem.offsetWidth || elem.offsetHeight || elem.getClientRects().length);
    }

    function sleep(min, max) {
        const ms = Math.floor(Math.random() * (max - min + 1) + min);
        return new Promise(r => setTimeout(r, ms));
    }

    function simulateClick(element) {
        ['mouseover', 'mousedown', 'mouseup', 'click'].forEach(eventType => {
            element.dispatchEvent(new MouseEvent(eventType, { bubbles: true, cancelable: true, view: window }));
        });
    }

    // --- 5. æ ¸å¿ƒé€»è¾‘ ---

    function handleResultState() {
        isBusy = true;
        // æ—¢ç„¶å·²ç»åˆ°äº†ç»“æœé¡µï¼Œè¯´æ˜ä¸Šæ¬¡çš„ä»»åŠ¡è‚¯å®šç»“æŸäº†ï¼Œé‡ç½®çŠ¶æ€
        data.status = 'idle';
        data.retryCount = 0;
        log("ğŸ” ç»“ç®—ç»“æœä¸­...", "step");

        const alertBox = document.querySelector(CONFIG.alertSelector);
        if (alertBox && isVisible(alertBox)) {
            const text = alertBox.innerText.trim();
            const match = text.match(/in\s+(\d+)\s+day/i);
            const captchaError = text.toLowerCase().includes("captcha");

            if (match && match[1]) {
                const days = parseInt(match[1], 10);
                data.nextRunTime = Date.now() + (days * 24 * 60 * 60 * 1000) + (1 * 60 * 60 * 1000);
                log(`âœ… æˆåŠŸ! ä¸‹æ¬¡: ${days}å¤©å`, "success");
            } else if (captchaError) {
                log("âŒ éªŒè¯ç é”™è¯¯ï¼Œ5åˆ†é’Ÿåé‡è¯•", "error");
                data.nextRunTime = Date.now() + (5 * 60 * 1000);
            } else {
                log("âš ï¸ æœªçŸ¥æç¤ºï¼Œé»˜è®¤æ¨è¿Ÿ12h", "warn");
                data.nextRunTime = Date.now() + (12 * 60 * 60 * 1000);
            }
        } else {
            // URLæœ‰errorä½†æ²¡çœ‹åˆ°æç¤ºï¼Œå¯èƒ½æ˜¯å› ä¸ºé¡µé¢è·³è½¬å¤ªå¿«æˆ–è€…æ ·å¼å˜äº†ï¼Œå®‰å…¨èµ·è§æ¨è¿Ÿ1å°æ—¶
            log("âŒ æœªè§è­¦å‘Šæ¡†ï¼Œæ¨è¿Ÿ1h", "error");
            data.nextRunTime = Date.now() + (60 * 60 * 1000);
        }

        saveData();
        log("ğŸ”„ 3ç§’åå›å¾…æœºé¡µ...", "step");
        setTimeout(() => { window.location.href = CONFIG.cleanUrl; }, 3000);
    }

    async function loop() {
        if (data.isPaused) { updateStatus("ğŸ”´ å·²æš‚åœ", "#ff4444"); return; }
        if (isBusy) { updateStatus("âš™ï¸ è¿è¡Œä¸­...", "#6f42c1"); return; }

        const now = Date.now();
        const diff = data.nextRunTime - now;

        if (diff > 0) {
            updateStatus(`â³ å€’è®¡æ—¶: ${formatTime(diff)}`);
            if (!refreshTimer && diff > 600000) {
                refreshTimer = setTimeout(() => {
                    if(!isBusy && !data.isPaused) location.reload();
                }, CONFIG.refreshInterval);
            }
            return;
        }

        await executeRenew();
    }

    async function executeRenew() {
        isBusy = true; // å†…å­˜é”ï¼Œé˜²æ­¢é‡å¤
        if (refreshTimer) clearTimeout(refreshTimer);

        // [é‡è¦ä¿®æ”¹] è¿™é‡Œå…ˆä¸è¦æ”¹ data.statusï¼Œä¹Ÿä¸è¦å­˜ç›˜
        // å¦‚æœåœ¨ sleep æœŸé—´é¡µé¢åˆ·æ–°ï¼Œè„šæœ¬é‡å¯å status ä¾ç„¶æ˜¯ idleï¼Œä¸ä¼šæŠ¥é”™

        log("ğŸ‘€ æ­£åœ¨è§‚å¯Ÿé¡µé¢ (5s)...", "step");
        await sleep(5000, 6000);

        // --- è§‚å¯ŸæœŸç»“æŸï¼Œç°åœ¨å¼€å§‹çœŸæ­£çš„æ“ä½œï¼Œæ­¤æ—¶æ‰ä¸Šé” ---

        data.status = 'renewing';
        // é¢„è®¾10åˆ†é’Ÿåè¿è¡Œï¼Œé˜²æ­¢æ­»å¾ªç¯
        data.nextRunTime = Date.now() + (10 * 60 * 1000);
        saveData();

        // 1. ç‚¹å‡» Renew
        const btn1 = document.querySelector(CONFIG.btnRenew);
        if (!btn1) {
            const visibleAlert = document.querySelector(CONFIG.alertSelector);
            if (visibleAlert && isVisible(visibleAlert)) {
                 log("âš ï¸ å·²æœ‰ç»“æœ", "warn");
                 handleResultState();
                 return;
            }
            log("âŒ æ‰¾ä¸åˆ°æŒ‰é’®", "error");
            data.status = 'idle'; // è§£é”
            isBusy = false;
            return;
        }

        log("ğŸ–±ï¸ ç‚¹å‡» Renew...", "info");
        simulateClick(btn1);

        log("âœ… (1/3) ç‚¹å‡»å®Œæˆ", "success");

        // 2. éšæœºç­‰å¾… (CFéªŒè¯)
        const waitTime = Math.floor(Math.random() * (9000 - 7000 + 1) + 7000);
        log(`â³ (2/3) ç­‰å¾… ${waitTime/1000}s (CF)...`, "step");
        await new Promise(r => setTimeout(r, waitTime));

        // 3. æäº¤
        const btn2 = document.querySelector(CONFIG.btnConfirm);
        if (!btn2) {
            log("âŒ æ‰¾ä¸åˆ° Confirm", "error");
            data.status = 'idle';
            isBusy = false;
            return;
        }

        log("ğŸš€ (3/3) æäº¤ä¸­...", "step");
        updateStatus("ğŸš€ æäº¤ä¸­...", "#00ff00");
        simulateClick(btn2);

        // ç‚¹å‡»åä»€ä¹ˆéƒ½ä¸åšï¼Œç­‰å¾…è·³è½¬
    }

    // --- 6. å¯åŠ¨æ£€æŸ¥ ---

    ui.btnManual.addEventListener('click', () => {
        if(confirm("é‡ç½®è„šæœ¬ï¼Ÿ")) {
            data.logs = [];
            data.nextRunTime = 0;
            data.isPaused = false;
            data.status = 'idle';
            data.retryCount = 0;
            saveData();
            window.location.href = CONFIG.cleanUrl;
        }
    });

    ui.btnPause.addEventListener('click', () => {
        data.isPaused = !data.isPaused;
        ui.btnPause.innerText = data.isPaused ? "æ¢å¤" : "æš‚åœ";
        saveData();
    });

    ui.btnHide.addEventListener('click', () => {
        const content = ui.content;
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
        ui.btnHide.innerText = content.style.display === 'none' ? '[+]' : '[-]';
    });

    ui.btnPause.innerText = data.isPaused ? "æ¢å¤" : "æš‚åœ";
    renderLogs();
    log("ğŸ¤– åŠ è½½ v2.5 (Stable)", "info");

    const currentUrl = window.location.href;
    const alertBox = document.querySelector(CONFIG.alertSelector);

    // [ä¼˜å…ˆçº§æœ€é«˜] 1. å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç»“æœé¡µ (Success/Error/Alert)
    if ((currentUrl.includes("renew-error") || currentUrl.includes("renew-success")) || (alertBox && isVisible(alertBox))) {
        // å¦‚æœå·²ç»åœ¨ç»“æœé¡µï¼Œç›´æ¥å¤„ç†ç»“æœï¼Œä¸å…³å¿ƒä¹‹å‰çš„çŠ¶æ€
        handleResultState();
    }
    // [ä¼˜å…ˆçº§æ¬¡ä¹‹] 2. æ£€æŸ¥æ˜¯å¦æ˜¯å¼‚å¸¸ä¸­æ–­ (Crash Recovery)
    else if (data.status === 'renewing') {
        if (data.retryCount < 3) {
            log(`ğŸš‘ å¼‚å¸¸æ¢å¤ (ç¬¬${data.retryCount + 1}æ¬¡)`, "warn");
            data.status = 'idle';
            data.nextRunTime = 0; // ç«‹å³é‡è¯•
            data.retryCount++;
            saveData();
            // è¿™é‡Œä¸åŠ  elseï¼Œè®©å®ƒå¾€ä¸‹èµ°è¿› loop()
        } else {
            log("âŒ å¤šæ¬¡å¤±è´¥ï¼Œå·²æš‚åœ", "error");
            data.status = 'idle';
            data.isPaused = true;
            data.retryCount = 0;
            saveData();
        }
    }

    // [æœ€å] 3. å¯åŠ¨ä¸»å¾ªç¯
    // å¦‚æœä¸Šé¢èµ°äº† handleResultStateï¼ŒisBusy ä¼šå˜æˆ trueï¼Œè¿™é‡Œå°±ä¸ä¼šå†²çª
    setInterval(loop, 1000);
    loop();

})();